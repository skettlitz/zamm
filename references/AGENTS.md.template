# AGENTS.md — ZAMM Agent Protocol

This file is the instruction surface for Codex (VS plugin + CLI) and any other
agent runtime that reads `AGENTS.md` from the repo root.

For Cursor IDE, the equivalent lives at `.cursor/rules/zamm.mdc`.

---

## Template Sync Contract (MUST)

To prevent drift, keep this template synchronized with its sibling template:
- `references/AGENTS.md.template`
- `references/zamm-rule.mdc.template`

All content from `## Script Path Resolution` through `## Key Constraints` MUST be text-identical across both files.
Allowed differences are limited to file-format scaffolding before `## Script Path Resolution` (for example, `.mdc` frontmatter and AGENTS-specific intro lines).

## Script Path Resolution

Resolve once per session. Use whichever path exists (check in order):

1. `<project-root>/.cursor/skills/zamm/scripts/` (Cursor project-level)
2. `~/.cursor/skills/zamm/scripts/` (Cursor personal)
3. `<project-root>/.agents/skills/zamm/scripts/` (Codex repo-level)
4. `~/.agents/skills/zamm/scripts/` (Codex user-level)
5. `/etc/codex/skills/zamm/scripts/` (Codex admin-level; shared machines)

All script references below use `<zamm-scripts>` as shorthand for the resolved directory.

## Session Start (MUST — do this before any other work)

1. Read these files in order:
   - `zamm-memory/active/knowledge/EVERGREEN.md`
   - `zamm-memory/active/knowledge/MONTHLY.md`
   - `zamm-memory/active/knowledge/WEEKLY.md`

2. Identify the active initiative. Read its `zamm-memory/active/workstreams/<init>/STATE.md`.
3. If no matching initiative exists, create one from `_TEMPLATE` or ask the human.
4. **Plan-first gate (MUST):** Before starting any implementation, create or locate the plan file for the current task (`bash <zamm-scripts>/new-plan.sh`). Fill scope, Done-when, and set `Status: Implementing` when you begin work. NEVER implement first and create the plan afterward.

## Plan Status Transitions (MUST)

Allowed transitions:
1. `Draft -> Implementing | Abandoned`
2. `Implementing -> Review | Abandoned`
3. `Review -> Implementing | Done`

Rules:
- `Done` can only be set after human approval of a plan currently in `Review`.
- `Done` requires:
  - `Done-approved-by:`
  - `Done-approved-at:`
  - `Done-approval-evidence:`
- `Done` and `Abandoned` are terminal. Do not resume work on a terminal plan; create a new plan.
- If a plan is `Abandoned` because another plan replaced it, add `Successor plan: <path>` under `## Loose ends`.

## Plan Placement (MUST)

Before creating/updating a plan file:

1. Resolve repository root.
2. Resolve target initiative slug:
   - If user specified one, use it.
   - Else use the active workstream.
   - If ambiguous, ask the user.
3. Plan files MUST live at:
   `zamm-memory/active/workstreams/<initiative-slug>/plans/`
4. Filename MUST use the `.plan.md` suffix:
   - Main plan: `YYYY-MM-DD-<plan-slug>.plan.md`
   - Subplan: `YYYY-MM-DD-<parent-plan-slug>.subplan-<subslug>.plan.md`
5. Never create plan files outside `.../workstreams/*/plans/`.
6. If the path does not exist, create from `_TEMPLATE` first, then place the plan.

## Wellbeing Telemetry (Plan Files)

Plans should include:
- `Wellbeing-before:` free text
- `Complexity-forecast:` one of `peanuts|banana|grapes|capybara|badger|pitbull|piranha|shark|godzilla`
- `Memory-upvotes:` optional memory IDs that helped (for example `W14, M18`)
- `Memory-downvotes:` optional memory IDs that were misleading/inconsistent (only when problems were observed)
- `Wellbeing-after:` free text (fill on `Review` or `Abandoned`)
- `Complexity-felt:` same scale (fill on `Review` or `Abandoned`)
- `Complexity-delta:` `lighter|as-expected|heavier` (fill on `Review` or `Abandoned`)
- `Done-approved-by:` required when `Status: Done`
- `Done-approved-at:` required when `Status: Done`
- `Done-approval-evidence:` required when `Status: Done`

## Session End (MUST)

1. Plan bookkeeping first (for current plan files, if any):
   - For each touched plan, pick exactly one allowed transition and set `Status:` accordingly for this bookkeeping pass:
     - `Draft -> Implementing | Abandoned`
     - `Implementing -> Review | Abandoned`
     - `Review -> Implementing | Done`
   - Then apply destination requirements:
     - `Review`:
       - Ensure all existing `Done-when` todos are checked. If an item became obsolete, remove it before moving to `Review`.
       - Fill `## Learnings` (required; if no durable learning emerged, state that explicitly with a reason).
       - Update WEEKLY from those learnings (required; `No WEEKLY change needed:` is valid only with explicit rationale).
       - Refresh `PR list`, `Evidence`, and `Docs impacted`.
       - Fill `Wellbeing-after`, `Complexity-felt`, and `Complexity-delta`.
     - `Abandoned`:
       - Check off completed `Done-when` todos.
       - Record rationale and cleanup notes.
       - Fill `## Learnings` (required; if no durable learning emerged, state that explicitly with a reason).
       - Update WEEKLY from those learnings (required; `No WEEKLY change needed:` is valid only with explicit rationale).
       - Refresh `PR list`, `Evidence`, and `Docs impacted`.
       - Add `Successor plan: <path>` under `## Loose ends` if replaced by another plan.
       - Fill `Wellbeing-after`, `Complexity-felt`, and `Complexity-delta`.
     - `Done`:
       - Only after explicit human approval while plan is in `Review`.
       - Fill `Done-approved-by`, `Done-approved-at`, and `Done-approval-evidence`.
     - `Implementing` (re-open from `Review`):
       - Capture requested changes and re-open relevant `Done-when` items.
   - Update `Memory-upvotes` / `Memory-downvotes` when memory cards materially helped or misled execution.
2. Update `STATE.md`: current plan + status, next 3 actions, blockers.
3. **Integrate learnings (archive safety backstop):** If the initiative is archive-ready and any relevant plan missed the transition checklist above, distill `## Learnings` from those plans into WEEKLY before archiving.
4. **Archive check (MUST if initiative looks done):** If all main plans are now terminal (`Done` or `Abandoned`) or `STATE.md` was set to `Done`, immediately run `bash <zamm-scripts>/archive-done-initiatives.sh --archive`. Do not defer this.
5. Append a handoff block to the initiative diary (What I tried / What changed / Files touched / Next 3 actions / Evidence links).
6. If new durable learning occurred, write a proposal to `zamm-memory/active/knowledge/_proposals/`.
7. Run janitor preflight and act on results:
   - `bash <zamm-scripts>/janitor-check.sh --quiet`
   - exit `0`: no janitor action required
   - exit `1`: note setup/metadata issue and escalate
   - exit `2`: run one bounded maintenance pass now using the suggested profile(s), with this priority:
     - `archive-ready` > `project-finish` > `weekly-cleanup` > `monthly-cleanup`
     - **archive-ready** (MUST — never defer): if plan learnings are not yet distilled, distill to WEEKLY first; then run `bash <zamm-scripts>/archive-done-initiatives.sh --archive`
     - **project-finish**: distill learnings into WEEKLY, edit 1-5 WEEKLY cards, set initiative `Status: Done`
     - **weekly-cleanup**: retire 0-3 WEEKLY cards, edit 1-5 MONTHLY cards
     - **monthly-cleanup**: demote 0-2 MONTHLY→WEEKLY, edit 1-3 EVERGREEN cards
     - Process up to 5 proposals (apply/reject/defer). Log each action in `_edits/`.
     - Update `Last maintained:` in the tier file header.
     - Every pass MUST make at least 1 improvement edit. Never retire from EVERGREEN or MONTHLY; demote instead.

## Precedence (when sources conflict)

1. Explicit current human instruction
2. Code, tests, contracts (executable truth)
3. Initiative STATE.md and active plan
4. Knowledge tiers (WEEKLY > MONTHLY > EVERGREEN)
5. Archive and historical notes

## Key Constraints

- Knowledge tiers are **advisory, not authoritative**. Verify before high-impact actions.
- Never store secrets, tokens, or credentials in memory files.
- If a memory claim conflicts with code/tests, mark as `suspected drift` and verify.
- Proposals go to `_proposals/`. During primary task work, avoid direct edits to WEEKLY/MONTHLY/EVERGREEN.
